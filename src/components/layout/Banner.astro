---
import type { ImageMetadata } from 'astro';
import { getImage } from 'astro:assets';
import defaultBannerImage from "@/src/assets/images/banners/Default_Banner.png";
import base_url from '@/src/lib/base_url';
import { getTrimmedPathname, navigation, comparePathname } from "@/src/lib/navigation";
import type { ChildNavigationItem } from '@/src/types';

interface Props {
  image?: ImageMetadata;
}

const { image }: Props = Astro.props;

// Optimize banner image
const optimizedImage = await getImage({
  src: image ?? defaultBannerImage,
  width: 2000,
  quality: 90,
  format: 'webp',
  filter: 'sharpen',
});
const bannerImageUrl = optimizedImage.src;

// Navigation helpers
const pathname = Astro.url.pathname;
const trimmedPathname = getTrimmedPathname(pathname);

const findSecondLevelPage = (): ChildNavigationItem | undefined => {
  const section = navigation.find(sec => trimmedPathname.startsWith(sec.url));
  return section?.pages?.find(page => trimmedPathname.startsWith(page.url));
};

const currentSecond = findSecondLevelPage();
const navItems = currentSecond?.pages ?? [];
const showSubNav = navItems.length > 0;

// Utility functions for template
const hasChildren = (item?: ChildNavigationItem) => Boolean(item?.pages?.length);
const dropdownId = (name: string) => `navbarDropdown-${name.replaceAll(' ', '-')}`;
const SUBNAV_ID = 'navbar-content2';
---
<div class="banner-container" style={`--banner-bg: url('${bannerImageUrl}')`}>
  <div class="banner-text-container container-xl flex-column">
    <div class="banner-text d-flex justify-content-between align-items-center">
      <div class="banner-title"><slot /></div>
      {showSubNav && (
        <button
          class="navbar-toggler"
          type="button"
          data-toggle="collapse"
          data-target={`#${SUBNAV_ID}`}
          aria-controls={SUBNAV_ID}
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
      )}
    </div>
    {showSubNav && (
      <nav
        class="navbar navbar-expand-lg navbar-dark navbar-marginbottom"
        aria-label="Section navigation"
      >
        <div class="collapse navbar-collapse" id={SUBNAV_ID}>
          <ul class="navbar-nav">
            {navItems.map(link => {
              const childPages = link.pages ?? [];
              const hasDropdown = hasChildren(link);
              const linkId = dropdownId(link.name);

              return (
                <li
                  class:list={[
                    'nav-item',
                    { dropdown: hasDropdown, activeMenu: trimmedPathname.startsWith(link.url) }
                  ]}
                >
                  <a
                    class:list={[
                      'nav-link',
                      { 'dropdown-toggle': hasDropdown, active: comparePathname(pathname, link.url, false) }
                    ]}
                    href={base_url(link.url)}
                    id={linkId}
                    role="button"
                    aria-expanded={hasDropdown ? 'false' : undefined}
                    aria-haspopup={hasDropdown ? 'true' : undefined}
                    tabindex={hasDropdown ? '0' : undefined}
                  >
                    {link.name}
                  </a>
                  {hasDropdown && (
                    <ul class="dropdown-menu mt-0 shadow" aria-labelledby={linkId}>
                      {childPages.map(pageLink => {
                        const pageChildren = pageLink.pages ?? [];
                        const hasSubmenu = pageChildren.length > 0;
                        const pageId = dropdownId(pageLink.name);

                        if (pageLink.isExternal) {
                          return (
                            <li>
                              <a
                                class="dropdown-item externalLink"
                                href={pageLink.url}
                                target="_blank"
                                rel="noopener noreferrer"
                              >
                                {pageLink.name}
                              </a>
                            </li>
                          );
                        }

                        if (hasSubmenu) {
                          return (
                            <li class="dropend">
                              <a
                                href={base_url(pageLink.url)}
                                class:list={[
                                  'dropdown-item',
                                  { 'dropdown-toggle': true, active: comparePathname(pathname, pageLink.url, true) }
                                ]}
                                aria-expanded="false"
                                aria-haspopup="true"
                                tabindex="0"
                                id={pageId}
                              >
                                {pageLink.name}
                              </a>
                              <ul class="dropdown-menu shadow" aria-labelledby={pageId}>
                                {pageChildren.map(subPageLink => {
                                  if (subPageLink.isExternal) {
                                    return (
                                      <li>
                                        <a
                                          class="dropdown-item externalLink"
                                          href={subPageLink.url}
                                          target="_blank"
                                          rel="noopener noreferrer"
                                        >
                                          {subPageLink.name}
                                        </a>
                                      </li>
                                    );
                                  }

                                  return (
                                    <li>
                                      <a
                                        class:list={['dropdown-item', { active: comparePathname(pathname, subPageLink.url) }]}
                                        href={base_url(subPageLink.url)}
                                      >
                                        {subPageLink.name}
                                      </a>
                                    </li>
                                  );
                                })}
                              </ul>
                            </li>
                          );
                        }

                        return (
                          <li>
                            <a
                              class:list={['dropdown-item', { active: comparePathname(pathname, pageLink.url) }]}
                              href={base_url(pageLink.url)}
                            >
                              {pageLink.name}
                            </a>
                          </li>
                        );
                      })}
                    </ul>
                  )}
                </li>
              );
            })}
          </ul>
        </div>
      </nav>
    )}
  </div>
</div>

<style>
/* Banner container and base layout */
.banner-container {
  background-image: var(--banner-bg);
  background-color: #05133e;
  position: relative;
  width: 100%;
  overflow: visible;
  display: flex;
  align-items: end;
  background-size: cover;
  background-position: center center;
  background-repeat: no-repeat;
  box-shadow: inset 0 10px 10px -10px rgba(0, 0, 0, 0.2), inset 0 -10px 10px -10px rgba(0, 0, 0, 0.2);
}

.banner-text-container {
  text-wrap: pretty;
  display: flex;
  justify-content: center;
  margin: auto;
}

.banner-text {
  font-size: 3rem;
  color: white;
  font-weight: bold;
  transition: font-size 0.2s ease;
  text-wrap: pretty;
}

.banner-image {
  display: none;
}

/* Navigation base styles */
.navbar {
  margin: 0;
  padding: 0;
  background: none;
}

.navbar-nav {
  display: flex;
  gap: 5px;
}

.nav-link {
  border-radius: 10px 10px 0 0;
  background-color: rgb(233, 236, 239, 0.25);
  transition: all 0.35s;
}

.navbar-dark .navbar-nav .nav-link {
  color: #f8f9fa;
}

.navbar-expand-lg .navbar-nav .nav-link {
  padding-right: 1rem;
  padding-left: 1rem;
}

.navbar-nav .nav-item .nav-link {
  font-size: 17px;
}

.nav-link:hover,
.active {
  background: white;
  color: black !important;
}

.dropdown-toggle.show {
  color: black;
  background-color: white;
  border-radius: 10px 10px 0 0;
  margin: 0;
}

.dropdown-menu {
  left: -1px;
  border: none;
}

.dropdown-menu .dropdown-item:hover,
.dropdown-menu .dropdown-item:focus {
  background-color: lightgray;
  color: #000;
}

.dropdown-menu li > ul.dropdown-menu {
  border-radius: 10px;
}

.dropend .dropdown-toggle::after {
  transform: rotate(270deg);
  transform-origin: center;
}


.dropdown-item.dropdown-toggle.show {
  background: rgb(233, 236, 239);
  border-radius: 0;
}

.dropdown-toggle::after,
.dropend .dropdown-toggle::after {
  content: "\f078";
  border: 0;
  color: black;
}


.dropdown-toggle::after,
.dropend .dropdown-toggle::after {
  content: "\f078";
  border: 0;
  color: white;
}

.dropdown-toggle:hover::after,
.dropend .dropdown-toggle:hover::after,
.dropdown-toggle:hover::after,
.dropdown-toggle.show::after,
.dropdown-toggle.active::after,
.activeMenu .dropdown-toggle::after
{
  content: "\f078";
  border: 0;
  color: black;
}

.navbar-nav .dropend .dropdown-menu {
  top: 0;
  right: auto;
  left: 100%;
  margin-top: 0;
}

.navbar-nav .nav-item.dropdown.show > .nav-link {
  font-weight: bold;
}

.navbar-marginbottom {
  margin-bottom: 0;
}

.navbar-toggler {
  display: none;
}

.navbar-toggler[aria-expanded='true'] .navbar-toggler-icon {
  background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 30 30' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M7 19l9-9 9 9' stroke='rgba(0,0,0,1' stroke-width='2' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3e%3c/svg%3e");
  align-self: center;
}

.navbar-toggler[aria-expanded='false'] .navbar-toggler-icon {
  background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 30 30' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M7 11l9 9 9-9' stroke='rgba(0,0,0,1)' stroke-width='2' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3e%3c/svg%3e");
  align-self: center;
}

.banner-text-container:not(:has(.navbar)) .navbar-toggler {
  display: none !important;
}

.dotlogo {
  max-height: 25px;
  object-fit: contain;
  object-position: 0%;
  padding-right: 10px;
  margin-top: 14px;
  margin-left: 30px;
}

/* Responsive: Tablets and Desktop */
@media (min-width: 992px) {
  .navbar-nav .nav-item.dropdown:hover > .dropdown-menu,
  .activeMenu a.dropdown-toggle {
    display: block;
    visibility: visible;
    opacity: 1;
    margin-top: 0;
  }

  .navbar-nav .nav-item.dropdown:hover > .nav-link,
  .activeMenu a.dropdown-toggle,
  .activeMenu .active .nav-link {
    color: black !important;
    background-color: white;
  }

  .navbar-nav .dropend:hover > .dropdown-menu,
  .activeMenu a.dropdown-toggle {
    display: block;
    visibility: visible;
    opacity: 1;
    color: black;
  }

  .navbar-nav .dropdown-toggle[aria-expanded='true'] + .dropdown-menu {
    display: block !important;
    visibility: visible;
    opacity: 1;
    margin-top: 0;
  }

  .navbar-nav .dropdown-toggle[aria-expanded='true'] {
    color: black !important;
    background-color: white;
  }

  .navbar-nav .dropdown-menu {
    display: none;
  }
}

/* Responsive: Large screens */
@media (max-width: 1200px) {
  .banner-text {
    font-size: 2.4rem;
  }

  .header-bar,
  .header-content {
    flex-wrap: wrap;
    width: 100%;
  }

  .siteheader-wrapper {
    flex-basis: 100%;
  }

  nav.navbar {
    flex-grow: 0;
    width: 100%;
    justify-content: flex-start;
  }
}

@media (max-width: 1040px) {
  .banner-text {
    font-size: 1.8rem;
  }
}

/* Responsive: Tablet/Mobile */
@media (max-width: 991.98px) {

  .dropend .dropdown-toggle.show::after {
  transform: rotate(0);
  transform-origin: center;
}

  .banner-text {
    font-size: 1.6rem;
  }
  
 .activeMenu .dropdown-toggle{
  background-color: white;
  color: black !important;
 }

  .navbar-toggler {
    display: block;
    margin-top: 0;
    padding: 0;
    width: 50px;
    height: 50px;
    background-color: rgb(255, 255, 255, 0.6);
  }

  .nav-link.show {
    color: black !important;
    background-color: white !important;
  }

  .banner-container {
    background-color: #091f61;
    background-image: none !important;
    align-items: stretch;
    min-height: 5rem;
  }

  .banner-text {
    background-image: var(--banner-bg);
    background-size: cover;
    background-position: center;
    padding: 12px;
    margin-bottom: 0;
    min-height: 5rem;
  }

  .navbar {
    background-color: #091f61;
  }

  .nav-item {
    margin: 0 1rem;
  }

  .navbar-collapse {
    padding: 1rem 0;
  }

  .nav-link {
    border-radius: 10px;
  }

  .banner-text-container {
    flex-direction: column;
    width: 100%;
    padding: 0;
  }
}

/* Responsive: Small devices */
@media (max-width: 768px) {
  .banner-text {
    font-size: 1.4rem;
  }
}

@media (max-width: 576px) {
  .banner-text {
    font-size: 1.2rem;
  }
}
    
</style>

{/* Mobile: First tap opens dropdown, second tap navigates. */}
<script is:inline>
  (function () {
    const BREAKPOINT = 992;
    const TAP_RESET_TIMEOUT = 5000;
    const FOCUS_DELAY = 50;

    const isDesktopViewport = () => window.innerWidth >= BREAKPOINT;

    const isInSameBranch = (toggle1, toggle2) => {
      if (!toggle1 || !toggle2) return false;
      const li1 = toggle1.parentElement;
      const li2 = toggle2.parentElement;
      return (
        toggle1.contains(toggle2) ||
        toggle2.contains(toggle1) ||
        (li1 && li1.contains(toggle2)) ||
        (li2 && li2.contains(toggle1))
      );
    };

    const hideDropdown = (toggle) => {
      try {
        if (window.bootstrap?.Dropdown) {
          const inst = window.bootstrap.Dropdown.getInstance(toggle);
          if (inst) {
            inst.hide();
            return;
          }
        }
      } catch (err) {}

      const parent = toggle.parentElement;
      if (parent) parent.classList.remove('show');
      const menu = parent?.querySelector(':scope > .dropdown-menu');
      if (menu) menu.classList.remove('show');
      toggle.setAttribute('aria-expanded', 'false');
    };

    const showDropdown = (toggle) => {
      try {
        if (window.bootstrap?.Dropdown) {
          window.bootstrap.Dropdown.getOrCreateInstance(toggle).show();
          return;
        }
      } catch (err) {}
      const parent = toggle.parentElement;
      if (parent) parent.classList.add('show');
    };

    const closeOpenDropdowns = (currentToggle) => {
      document.querySelectorAll('.navbar .dropdown-toggle.show').forEach((toggle) => {
        if (toggle === currentToggle || isInSameBranch(toggle, currentToggle)) return;
        hideDropdown(toggle);
        delete toggle.dataset.dropdownTap;
      });

      document.querySelectorAll('.navbar .dropdown-menu.show').forEach((menu) => {
        const toggle = menu.previousElementSibling;
        if (toggle === currentToggle || (menu.contains(currentToggle) || (toggle && isInSameBranch(toggle, currentToggle)))) {
          return;
        }
        menu.classList.remove('show');
        menu.parentElement?.classList.remove('show');
        toggle?.setAttribute('aria-expanded', 'false');
      });
    };

    const navigateToLink = (element) => {
      const href = element.getAttribute?.('href');
      if (href && href !== '#' && href !== 'javascript:void(0)') {
        window.location.href = href;
        return true;
      }
      return false;
    };

    // ============================================================================
    // CLICK/TAP HANDLERS
    // ============================================================================

    const handleDropdownClick = (e) => {
      const toggle = e.target.closest?.('.navbar .dropdown-toggle');
      if (!toggle) return;

      if (isDesktopViewport()) {
        navigateToLink(toggle);
        return;
      }

      if (toggle.dataset.dropdownTap === '1') {
        delete toggle.dataset.dropdownTap;
        if (navigateToLink(toggle)) e.preventDefault();
        return;
      }

      e.preventDefault();
      toggle.dataset.dropdownTap = '1';
      closeOpenDropdowns(toggle);
      toggle.setAttribute('aria-expanded', 'true');
      showDropdown(toggle);

      setTimeout(() => {
        try {
          delete toggle.dataset.dropdownTap;
        } catch (err) {}
      }, TAP_RESET_TIMEOUT);
    };

    // ============================================================================
    // KEYBOARD HANDLERS
    // ============================================================================

    const handleKeyboardInteraction = (e) => {
      const toggle = e.target.closest?.('.navbar .dropdown-toggle');
      if (!toggle) return;
      const parent = toggle.parentElement;

      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        const isOpen = parent?.classList.contains('show');

        if (isDesktopViewport()) {
          if (!isOpen) {
            closeOpenDropdowns(toggle);
            toggle.setAttribute('aria-expanded', 'true');
            showDropdown(toggle);
            setTimeout(() => {
              const menu = parent?.querySelector(':scope > .dropdown-menu');
              const firstItem = menu?.querySelector('.dropdown-item');
              firstItem?.focus();
            }, FOCUS_DELAY);
          }
          return;
        }

        if (isOpen) {
          hideDropdown(toggle);
          parent?.querySelector(':scope > .dropdown-menu')?.classList.remove('show');
          toggle.setAttribute('aria-expanded', 'false');
        } else {
          closeOpenDropdowns(toggle);
          toggle.dataset.dropdownTap = '1';
          toggle.setAttribute('aria-expanded', 'true');
          showDropdown(toggle);
        }
        return;
      }

      if (e.key === 'Escape') {
        e.preventDefault();
        hideDropdown(toggle);
        parent?.querySelector(':scope > .dropdown-menu')?.classList.remove('show');
        toggle.setAttribute('aria-expanded', 'false');
        toggle.focus();
        return;
      }

      if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
        const menu = e.target.closest?.('.dropdown-menu');
        if (menu) {
          e.preventDefault();
          const items = Array.from(menu.querySelectorAll('.dropdown-item'));
          if (items.length > 0) {
            const currentIndex = items.indexOf(document.activeElement);
            const nextIndex = e.key === 'ArrowDown'
              ? (currentIndex + 1) % items.length
              : (currentIndex - 1 + items.length) % items.length;
            items[nextIndex].focus();
          }
          return;
        }

        const toggleMenu = parent?.querySelector(':scope > .dropdown-menu');
        if (toggleMenu) {
          e.preventDefault();
          const items = Array.from(toggleMenu.querySelectorAll('.dropdown-item'));
          if (items.length > 0) {
            const targetItem = e.key === 'ArrowDown' ? items[0] : items[items.length - 1];
            targetItem.focus();
          }
        }
      }
    };

    // ============================================================================
    // FOCUS HANDLERS
    // ============================================================================

    const maintainDropdownOnFocus = (element) => {
      const menu = element.closest('.dropdown-menu');
      if (!menu) return;
      const toggle = menu.previousElementSibling;
      if (toggle?.classList.contains('dropdown-toggle')) {
        toggle.setAttribute('aria-expanded', 'true');
        showDropdown(toggle);
      }
    };

    const handleFocusIn = (e) => {
      const item = e.target;
      if (isDesktopViewport() && item.classList.contains('dropdown-toggle')) {
        closeOpenDropdowns(item);
        item.setAttribute('aria-expanded', 'true');
        showDropdown(item);
      }

      if (item.classList.contains('dropdown-item') || item.classList.contains('dropdown-toggle')) {
        maintainDropdownOnFocus(item);
      }
    };

    const handleFocusOut = (e) => {
      const menu = e.target.closest?.('.dropdown-menu');
      if (!menu) return;
      const nextFocus = e.relatedTarget;
      const toggle = menu.previousElementSibling;
      if (!nextFocus || (!menu.contains(nextFocus) && nextFocus !== toggle)) {
        if (toggle?.classList.contains('dropdown-toggle')) {
          hideDropdown(toggle);
          toggle.setAttribute('aria-expanded', 'false');
        }
      }
    };

    // ============================================================================
    // EVENT LISTENER REGISTRATION
    // ============================================================================

    document.addEventListener('click', handleDropdownClick, { passive: false });
    document.addEventListener('keydown', handleKeyboardInteraction, { passive: false });
    document.addEventListener('focusin', handleFocusIn, { passive: true });
    document.addEventListener('focusout', handleFocusOut, { passive: true });
  })();
</script>