---
import type { ImageMetadata } from 'astro';
import { getImage } from 'astro:assets';
import defaultBannerImage from "@/src/assets/images/banners/Default_Banner.png";
import base_url from '@/src/lib/base_url';
import { getTrimmedPathname, navigation, comparePathname } from "@/src/lib/navigation";
import type { ChildNavigationItem } from '@/src/types';

interface Props {
  image?: ImageMetadata;
}

const { image } = Astro.props;
// Optimize the banner image
const optimizedImage = await getImage({
  src: image ?? defaultBannerImage,
  width: 1200,
  quality: 90,
  format: 'webp',
});
const bannerImageUrl = optimizedImage.src;

// SubNavigation logic
// Shows a contextual sub-navigation bar for sections that have a 3rd level of pages.
// The full current pathname from Astro (may include base path)
const pathname = Astro.url.pathname;
// Trim trailing slash and base path so comparisons are consistent across environments
const trimmedPathname = getTrimmedPathname(pathname);

// Determine the current top-level section and the current second-level page.
// We only show this subnav when the current second-level page contains third-level pages.
const currentSection = navigation.find(sec => trimmedPathname.startsWith(sec.url));
let currentSecond: ChildNavigationItem | undefined = undefined;
if (currentSection && currentSection.pages) {
  // Find the second-level page that the current path belongs to (e.g., `/research-areas/ITS4US`)
  currentSecond = currentSection.pages.find(p => trimmedPathname.startsWith(p.url)) as ChildNavigationItem | undefined;
}
// showSubNav true => render the nav; navItems contains the third-level pages to render
// There is a bit of a problem with the active class being applied to the index of a section, but this has been address by using css to only apply to items with the dropdown-toggle class
const showSubNav = Boolean(currentSecond && currentSecond.pages && currentSecond.pages.length > 0);
const navItems = showSubNav && currentSecond ? (currentSecond.pages ?? []) : [];
---
<div class="banner-container" style={`--banner-bg: url('${bannerImageUrl}')`}>
  <div class="banner-text-container container-xl flex-column ">
    <div class="banner-text d-flex justify-content-between align-items-center">
      <div class=""><slot/></div>

       <button
              class="navbar-toggler"
              type="button"
              data-toggle="collapse"
              data-target="#navbar-content2"
              aria-controls="navbar-content2"
              aria-expanded="false"
              aria-label="Toggle navigation"
            >
              <span class="navbar-toggler-icon"></span>
            </button>
      
    </div>
    {showSubNav && (
        <nav class="navbar navbar-expand-lg navbar-dark navbar-marginbottom ">
          
           
            <div class="collapse navbar-collapse" id="navbar-content2">
              <ul class="navbar-nav">
                {navItems.map(link => (
                  <li class:list={["nav-item", {"dropdown": (link.pages && link.pages.length > 0), "activeMenu": trimmedPathname.startsWith(link.url)}]}>
                    {/* Top-level anchor for this subnav entry. `comparePathname` marks it active when it matches */}
                    <a 
                      class:list={[
                        "nav-link",
                        {"dropdown-toggle": link.pages && link.pages.length > 0},
                        {"active": comparePathname(pathname, link.url, false)}
                      ]}
                      href={base_url(link.url)}
                      id={"navbarDropdown-" + link.name.replaceAll(" ", "-")}
                      role="button"
                      aria-expanded={link.pages && link.pages.length > 0 ? "false" : undefined}
                      aria-haspopup={link.pages && link.pages.length > 0 ? "true" : undefined}
                      tabindex={link.pages && link.pages.length > 0 ? "0" : undefined}
                    >
                      {link.name}
                    </a>
                    
                    {link.pages && link.pages.length > 0 && (
                      <ul class="dropdown-menu mt-0 shadow" aria-labelledby={"navbarDropdown-" + link.name.replaceAll(" ", "-")}>
                        {(link.pages ?? []).map(pageLink => {
                          /*
                            pageLink may be an external link (open in new tab), a link with further children
                            (render a dropend submenu), or a plain link. We render `active` classes using
                            `comparePathname` so the current page is visibly highlighted.
                          */
                          if (pageLink.isExternal) return (
                            <li>
                              <a class="dropdown-item externalLink" href={pageLink.url} target="_blank" rel="noopener noreferrer">
                                {pageLink.name}
                              </a>
                            </li>
                          );
                          if (pageLink.pages) return (
                            <li class="dropend">
                              
                              <a 
                                href={base_url(pageLink.url)}
                                class:list={["dropdown-item", {"dropdown-toggle": true, "active": comparePathname(pathname, pageLink.url, true)}]}
                                aria-expanded="false"
                                aria-haspopup="true"
                                tabindex="0"
                              >
                                {pageLink.name}
                              </a>
                              <ul class="dropdown-menu shadow">
                                {(pageLink.pages ?? []).map(subPageLink => {
                                  if (subPageLink.isExternal) return (
                                    <li>
                                      <a 
                                        class="dropdown-item externalLink" 
                                        href={subPageLink.url}
                                      >
                                        {subPageLink.name}
                                      </a>
                                    </li>
                                  )
                                  return (
                                    <li>
                                      <a 
                                        class:list={[
                                          "dropdown-item", 
                                          {"disabled": [
                                              "ITS Professional Capacity Building", 
                                              "Architecture, Standards, and Cybersecurity (ASC)"
                                            ].includes(subPageLink.name)
                                          },
                                          {"active": comparePathname(pathname, subPageLink.url)}
                                        ]} 
                                        href={base_url(subPageLink.url)}
                                      >
                                        {subPageLink.name}
                                      </a>
                                    </li>
                                  )
                                })}
                              </ul>
                            </li>
                          )
                          return (
                            <li>
                              <a class:list={["dropdown-item", {"active": comparePathname(pathname, pageLink.url)}]} href={base_url(pageLink.url)}>
                                {pageLink.name}
                              </a>
                            </li>
                          )
                        })}
                      </ul>
                    )}
                  </li>
                ))}
              </ul>
            </div>
          
        </nav>
      )}
  </div>
</div>

<style>
.banner-container {
  /* THIS LINE IS CRITICAL: It grabs the image from the HTML variable */
  background-image: var(--banner-bg);
  background-color: #05133e;

  /* Existing styles */
  position: relative;
  min-height: 7rem;
  width: 100%;
  overflow: visible;
  display: flex;
  align-items: end;
  background-size: cover;
  background-position: center center;
  background-repeat: no-repeat;
  box-shadow: inset 0 10px 10px -10px rgba(0,0,0,0.2),inset 0 -10px 10px -10px rgba(0,0,0,0.2);
  -moz-box-shadow: inset 0 10px 10px -10px rgba(0,0,0,0.2),inset 0 -10px 10px -10px rgba(0,0,0,0.2);
  -webkit-box-shadow: inset 0 10px 10px -10px rgba(0,0,0,0.2),inset 0 -10px 10px -10px rgba(0,0,0,0.2);
}
  .banner-image {
    display: none;
  }

  .banner-text-container {
    text-wrap: pretty;
    display: flex;
    justify-content: center;
    
    margin: auto;
  }



  .banner-text {
    font-size: 3rem;
    color: white;
    font-weight:bold;
    transition: font-size 0.2s ease;
    text-wrap: pretty;
  }

  /* 1200, 992, 768, 576 */
@media (max-width: 1200px) {
  .banner-text {
    font-size: 2.4rem;
  }
}

@media (max-width: 1040px) {
  .banner-text {
    font-size: 1.8rem;
  }
}
@media (max-width: 992px) {
  .banner-text {
    font-size: 1.6rem;
  }
}
@media (max-width: 768px) {
  .banner-text {
    font-size: 1.4rem;
  }
}

@media (max-width: 576px) {
  .banner-text {
    font-size: 1.2rem;
  }
}

  /* SubNavigation styles */
  a,
  ul,
  li,
  nav,
  button
  .show {
    transition: all 0.35s;
  }
   .navbar-nav .nav-item .nav-link {
    font-size: 17px;
  }
.navbar-expand-lg .navbar-nav .nav-link {
    padding-right: 1rem;
    padding-left: 1rem;
  }
  .nav-link{
    border-radius: 10px 10px 0 0;
    background-color: rgb(233, 236, 239, 0.25);

  }
  .navbar-dark .navbar-nav .nav-link {
    color: #f8f9fa;
  }

  .navbar {
    margin: 0;
    padding: 0;
    background: none;
  }

  .navbar-nav {
      display: flex;
      gap: 5px;
  }

  .active, .nav-link:hover {
    background: white;
    color: black !important;
  }

  .dotlogo {
    max-height: 25px;
    object-fit: contain;
    object-position: 0%;
    padding-right: 10px;
    margin-top: 14px;
    margin-left: 30px;
  }

  .dropdown-toggle.show {
    color: black;
    background-color: white;
    border-radius: 10px 10px 0px 0px;
    margin: 0;
  }

  .dropdown-toggle .show {
    color: black;
  }

  .dropdown-menu {
    left: -1px;
  }

  .show.nav-link:focus {
    color: black;
  }

  .dropdown-menu li > ul.dropdown-menu {
    border-radius: 10px;
  }

  .dropend .dropdown-toggle::after {
    content: "\f078";
    border: 0; 
    color: black;
    transform: rotate(270deg);
    transform-origin: center;
  }


    .dropend:hover .dropdown-toggle:hover::after {
      content: "\f078";
      border: 0;
      color: black;
      
    transform: rotate(270deg);
    }

    /* Position the last dropend menu to the right instead of below */
    .navbar-nav .dropend .dropdown-menu {
     top: 0;
    right: auto;
    left: 100%;
    margin-top: 0;
    }

    @media (min-width: 992px) {
      .navbar-nav .dropend:hover > .dropdown-menu {
       top: 0;
    right: auto;
    left: 100%;
    margin-top: 0;
      }
    }
   @media (min-width: 992px) {
    .navbar-nav .nav-item.dropdown:hover > .dropdown-menu, .activeMenu  a.dropdown-toggle {
      display: block;
      visibility: visible;
      opacity: 1;
      margin-top: 0;
    }
    .navbar-nav .nav-item.dropdown:hover > .nav-link, .activeMenu  a.dropdown-toggle {
      color: black !important;
      background-color: white;
    }
    .navbar-nav .dropend:hover > .dropdown-menu, .activeMenu  a.dropdown-toggle {
      display: block;
      visibility: visible;
      opacity: 1;
      color: black;
    }
    /* Show dropdowns when aria-expanded is true (keyboard navigation) */
    .navbar-nav .dropdown-toggle[aria-expanded="true"] + .dropdown-menu {
      display: block !important;
      visibility: visible;
      opacity: 1;
      margin-top: 0;
    }
    .navbar-nav .dropdown-toggle[aria-expanded="true"] {
      color: black !important;
      background-color: white;
    }
    /* hide dropdowns by default on desktop until hover */
    .navbar-nav .dropdown-menu {
      display: none;
    }
  
  }

  .dropdown-item.dropdown-toggle.show::after {
    content: "\f078";
    border: 0;
    color: black;
    transform: rotate(0);
  }
  .dropdown-item.dropdown-toggle.show{
    background: rgb(233, 236, 239);
    border-radius: 0;
  }
  .dropdown-menu{
    border: none;
  }

  @media (max-width: 992px) {
    .navbar-marginbottom {
      margin-bottom: 0;
    }
  }
  .navbar-nav .nav-item.dropdown.show > .nav-link {
    font-weight: bold;
  }

  /* Show dropdowns on hover for desktop/tablet (keep click behavior on small screens) */
  @media (min-width: 992px) {
    /* main dropdown */
    .navbar-nav .nav-item.dropdown:hover > .dropdown-menu {
      display: block;
      visibility: visible;
      opacity: 1;
      margin-top: 0; /* align with Bootstrap spacing */
    }

    /* make the toggle appear active on hover */
    .navbar-nav .nav-item.dropdown:hover > .nav-link {
      color: black;
      background-color: white;
      border-radius: 10px 10px 0 0;
    }

    /* nested (dropend) submenu on hover */
    .navbar-nav .dropend:hover > .dropdown-menu {
      display: block;
      visibility: visible;
      opacity: 1;
     
    }

    /* ensure dropdown-menu default is hidden until hover (desktop) */
    .navbar-nav .dropdown-menu {
      display: none;
    }
  }


  /* Make dropdown items light gray on hover/focus for better visibility */
  .dropdown-menu .dropdown-item:hover,
  .dropdown-menu .dropdown-item:focus {
    background-color: lightgray; /* light gray */
    color: #000; /* ensure readable text */
  }



  
  /* ===== Responsive adjustments ===== */
  @media (max-width: 1200px) {
    .header-bar {
      flex-wrap: wrap;
    }
    .header-content {
      flex-wrap: wrap;
      width: 100%;
    }
    .siteheader-wrapper {
      flex-basis: 100%;
    }
    nav.navbar {
      flex-grow: 0;
      width: 100%;
      justify-content: flex-start;
    }

  }

  @media (max-width: 992px) {
    .navbar-marginbottom {
      margin-bottom: 0;
    }
      .nav-link.show {
      color: black !important;
      background-color: white !important;
    }
    
  }


  .navbar-toggler{
    display: none;
  }
/* If the container does NOT have a .navbar child, hide the toggler */
.banner-text-container:not(:has(.navbar)) .navbar-toggler {
  display: none !important;
}
  



  @media (max-width: 992px) {
    .Topbar .col-lg-2 {
      width: 50%;
    }
    .navbar-toggler {
      display: block;
      margin-top: 0px;
      padding: 0px;
      width: 50px;
      height: 50px;
      background-color: rgb(255, 255, 255, 0.60);
    }

    /* Show a chevron up when the toggler is expanded */
    .navbar-toggler[aria-expanded="true"] .navbar-toggler-icon {
      background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 30 30' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M7 19l9-9 9 9' stroke='rgba(0,0,0,1' stroke-width='2' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3e%3c/svg%3e");
      align-self: center;
    }

    /* Show a chevron down when the toggler has the `collapsed` class (default) */
    .navbar-toggler[aria-expanded="false"] .navbar-toggler-icon {
      background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 30 30' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M7 11l9 9 9-9' stroke='rgba(0,0,0,1)' stroke-width='2' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3e%3c/svg%3e");
      align-self: center;
    }

    
/* --- DEFAULT / DESKTOP (Keep existing behavior) --- */

/* --- MOBILE OVERRIDES (< 992px) --- */
@media (max-width: 992px) {
  
  /* 1. Remove image from the main parent wrapper */
  .banner-container {
    background-color: #091f61; /* Background color for slow loading images */
    background-image: none !important; 
    align-items: stretch; /* Let children determine height */
    min-height: 5rem;
  }

  /* 2. Move the image to the Text Container only */
  .banner-text {
    background-image: var(--banner-bg);
    background-size: cover;
    background-position: center;
    
    /* Visual adjustments so the image looks like a banner */
    padding:  12px;         /* Add padding so image is visible around text */
    margin-bottom: 0;
    min-height: 5rem;

  }

  /* 3. Give the Nav a solid background so it looks like a separate block */
  .navbar {
    background-color: #091f61; /* Dark Grey (Matches standard Bootstrap dark) */
    /* Or use: background-color: black; */
   
    padding: 0;
  }
  .nav-item{
    margin: 0 1rem;
  }
  .navbar-collapse{
    padding: 1rem 0;
  }

  .nav-link{
     border-radius: 10px;
  }

  .banner-text-container {
    /* Ensure flex column so Nav sits physically below Text */
    flex-direction: column;
    width: 100%;
    padding: 0; /* Remove padding so full-width works */
  }
}
    
</style>

{/* Mobile: First tap opens dropdown, second tap navigates. */}
<script is:inline>
  (function () {
    // Only apply this behavior on narrow viewports (mobile/tablet)
    const BREAKPOINT = 992;

    function closeOpenDropdowns(currentToggle) {
      const toggles = document.querySelectorAll('.navbar .dropdown-toggle.show');
      toggles.forEach(tgl => {
        if (tgl === currentToggle) return;
        // Keep ancestor/descendant branches open so submenus still work
        const tglLi = tgl.parentElement;
        const curLi = currentToggle.parentElement;
        const sameBranch =
          tgl.contains(currentToggle) ||
          currentToggle.contains(tgl) ||
          (tglLi && tglLi.contains(currentToggle)) ||
          (curLi && curLi.contains(tgl));
        if (sameBranch) return;
        try {
          if (window.bootstrap && typeof window.bootstrap.Dropdown !== 'undefined') {
            const inst = window.bootstrap.Dropdown.getInstance(tgl);
            if (inst) inst.hide();
          }
        } catch (err) {
          // ignore
        }
        const parent = tgl.parentElement;
        if (parent) parent.classList.remove('show');
        const menu = parent && parent.querySelector(':scope > .dropdown-menu');
        if (menu) menu.classList.remove('show');
        tgl.setAttribute('aria-expanded', 'false');
        delete tgl.dataset.dropdownTap;
      });

      const menus = document.querySelectorAll('.navbar .dropdown-menu.show');
      menus.forEach(menu => {
        const toggle = menu.previousElementSibling;
        if (toggle === currentToggle) return;
        const toggleLi = toggle && toggle.parentElement;
        const curLi = currentToggle.parentElement;
        const sameBranch =
          menu.contains(currentToggle) ||
          (toggle && currentToggle.contains(toggle)) ||
          (toggleLi && toggleLi.contains(currentToggle)) ||
          (curLi && curLi.contains(toggle));
        if (sameBranch) return;
        menu.classList.remove('show');
        if (menu.parentElement) menu.parentElement.classList.remove('show');
        if (toggle) toggle.setAttribute('aria-expanded', 'false');
      });
    }

    function onBodyClick(e) {
      // Only handle left-click / taps
      const el = e.target.closest && e.target.closest('.navbar .dropdown-toggle');
      if (!el) return;

      const isDesktop = window.innerWidth >= BREAKPOINT;

      // Desktop: navigate to the link (submenu shown on hover)
      if (isDesktop) {
        const href = el.getAttribute && el.getAttribute('href');
        if (href && href !== '#' && href !== 'javascript:void(0)') {
          window.location.href = href;
        }
        return;
      }

      // Mobile: First tap opens dropdown, second tap navigates
      // If this toggle was tapped once already, navigate to the link target.
      if (el.dataset.dropdownTap === '1') {
        // cleanup marker so subsequent taps behave normally
        delete el.dataset.dropdownTap;
        // Try to read the href and navigate explicitly. Some mobile dropdown
        // handlers (Bootstrap) can prevent the native navigation on dropdown toggles,
        // so we set location.href directly to guarantee navigation.
        const href = el.getAttribute && el.getAttribute('href');
        if (href && href !== '#' && href !== 'javascript:void(0)') {
          // prevent any default handling and force navigation
          e.preventDefault();
          window.location.href = href;
        }
        return;
      }

      // First tap: prevent navigation and open the dropdown
      e.preventDefault();
      el.dataset.dropdownTap = '1';
      closeOpenDropdowns(el);
      el.setAttribute('aria-expanded', 'true');
      try {
        // Use Bootstrap's Dropdown API if available to open the menu
        if (window.bootstrap && typeof window.bootstrap.Dropdown !== 'undefined') {
          window.bootstrap.Dropdown.getOrCreateInstance(el).show();
        } else {
          // Fallback: add class to parent to show menu (relies on CSS hover rules)
          const parent = el.parentElement;
          if (parent) parent.classList.add('show');
        }
      } catch (err) {
        // ignore
      }

      // Reset the tap marker after 5 seconds so the link doesn't stay "armed" forever
      setTimeout(() => { try { delete el.dataset.dropdownTap } catch (e) {} }, 5000);
    }

    document.addEventListener('click', onBodyClick, { passive: false });

    // Keyboard accessibility: handle Enter/Space to toggle dropdowns, Escape to close
    function onKeyDown(e) {
      const el = e.target.closest && e.target.closest('.navbar .dropdown-toggle');
      if (!el) return;

      const isDesktop = window.innerWidth >= BREAKPOINT;

      // Enter or Space to toggle dropdown
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        const parent = el.parentElement;
        const isOpen = parent && parent.classList.contains('show');

        if (isDesktop) {
          // Desktop: open and focus first item
          if (!isOpen) {
            closeOpenDropdowns(el);
            el.setAttribute('aria-expanded', 'true');
            try {
              if (window.bootstrap && typeof window.bootstrap.Dropdown !== 'undefined') {
                window.bootstrap.Dropdown.getOrCreateInstance(el).show();
              } else if (parent) {
                parent.classList.add('show');
              }
            } catch (err) {
              // ignore
            }
            setTimeout(() => {
              const menu = parent && parent.querySelector(':scope > .dropdown-menu');
              if (menu) {
                const firstItem = menu.querySelector('.dropdown-item');
                if (firstItem) firstItem.focus();
              }
            }, 50);
          }
          return;
        }

        // Mobile: toggle the dropdown
        if (isOpen) {
          try {
            if (window.bootstrap && typeof window.bootstrap.Dropdown !== 'undefined') {
              const inst = window.bootstrap.Dropdown.getInstance(el);
              if (inst) inst.hide();
            }
          } catch (err) {
            // ignore
          }
          parent.classList.remove('show');
          const menu = parent && parent.querySelector(':scope > .dropdown-menu');
          if (menu) menu.classList.remove('show');
          el.setAttribute('aria-expanded', 'false');
        } else {
          closeOpenDropdowns(el);
          el.dataset.dropdownTap = '1';
          el.setAttribute('aria-expanded', 'true');
          try {
            if (window.bootstrap && typeof window.bootstrap.Dropdown !== 'undefined') {
              window.bootstrap.Dropdown.getOrCreateInstance(el).show();
            } else {
              parent.classList.add('show');
            }
          } catch (err) {
            // ignore
          }
        }
        return;
      }

      // Escape to close dropdown
      if (e.key === 'Escape') {
        e.preventDefault();
        const parent = el.parentElement;
        try {
          if (window.bootstrap && typeof window.bootstrap.Dropdown !== 'undefined') {
            const inst = window.bootstrap.Dropdown.getInstance(el);
            if (inst) inst.hide();
          }
        } catch (err) {
          // ignore
        }
        parent.classList.remove('show');
        const menu = parent && parent.querySelector(':scope > .dropdown-menu');
        if (menu) menu.classList.remove('show');
        el.setAttribute('aria-expanded', 'false');
        el.focus();
      }

      // Arrow keys for navigation within open menus
      if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
        const menu = e.target.closest('.dropdown-menu');
        if (menu) {
          e.preventDefault();
          const items = Array.from(menu.querySelectorAll('.dropdown-item'));
          if (items.length > 0) {
            const currentIndex = items.indexOf(document.activeElement);
            let nextIndex = currentIndex;
            if (e.key === 'ArrowDown') nextIndex = (currentIndex + 1) % items.length;
            else nextIndex = (currentIndex - 1 + items.length) % items.length;
            items[nextIndex].focus();
          }
          return;
        }

        // If on toggle with menu, focus first/last item
        const parent = el.parentElement;
        const toggleMenu = parent && parent.querySelector(':scope > .dropdown-menu');
        if (toggleMenu) {
          e.preventDefault();
          const items = Array.from(toggleMenu.querySelectorAll('.dropdown-item'));
          if (items.length > 0) {
            const targetItem = e.key === 'ArrowDown' ? items[0] : items[items.length - 1];
            targetItem.focus();
          }
        }
      }
    }

    document.addEventListener('keydown', onKeyDown, { passive: false });

    // Keep dropdown open when any of its items have focus (for tab navigation)
    function keepDropdownOpen(element) {
      let menu = element.closest('.dropdown-menu');
      if (!menu) return;
      
      const toggle = menu.previousElementSibling;
      if (toggle && toggle.classList.contains('dropdown-toggle')) {
        toggle.setAttribute('aria-expanded', 'true');
        try {
          if (window.bootstrap && typeof window.bootstrap.Dropdown !== 'undefined') {
            window.bootstrap.Dropdown.getOrCreateInstance(toggle).show();
          }
        } catch (err) {
          // ignore
        }
      }
    }

    function onFocusIn(e) {
      const item = e.target;

      // If focusing a top-level toggle on desktop, open it for keyboard users
      if (window.innerWidth >= BREAKPOINT && item.classList.contains('dropdown-toggle')) {
        closeOpenDropdowns(item);
        item.setAttribute('aria-expanded', 'true');
        try {
          if (window.bootstrap && typeof window.bootstrap.Dropdown !== 'undefined') {
            window.bootstrap.Dropdown.getOrCreateInstance(item).show();
          }
        } catch (err) {
          // ignore
        }
      }

      // Keep dropdown open if focusing any item in a dropdown
      if (item.classList.contains('dropdown-item') || item.classList.contains('dropdown-toggle')) {
        keepDropdownOpen(item);
      }
    }

    function onFocusOut(e) {
      const menu = e.target.closest('.dropdown-menu');
      if (!menu) return;
      
      // Only close if focus is not going to another item in the same menu or its toggle
      const nextFocus = e.relatedTarget;
      const toggle = menu.previousElementSibling;
      
      if (!nextFocus || (!menu.contains(nextFocus) && nextFocus !== toggle)) {
        const dropdownToggle = menu.previousElementSibling;
        if (dropdownToggle && dropdownToggle.classList.contains('dropdown-toggle')) {
          try {
            if (window.bootstrap && typeof window.bootstrap.Dropdown !== 'undefined') {
              const inst = window.bootstrap.Dropdown.getInstance(dropdownToggle);
              if (inst) inst.hide();
            }
          } catch (err) {
            // ignore
          }
          dropdownToggle.setAttribute('aria-expanded', 'false');
        }
      }
    }

    document.addEventListener('focusin', onFocusIn, { passive: true });
    document.addEventListener('focusout', onFocusOut, { passive: true });
  })();
</script>